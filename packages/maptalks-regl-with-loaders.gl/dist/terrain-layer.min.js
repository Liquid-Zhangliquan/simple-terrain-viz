/*!
 * author: sakitam-fdd <smilefdd@gmail.com>
 * maptalks-regl-with-loaders.gl v1.0.0
 * build-time: 2021-1-14 19:24
 * LICENSE: MIT
 * (c) 2020-2021 https://github.com/sakitam-gis/simple-terrain-viz
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("regl"),require("maptalks")):"function"==typeof define&&define.amd?define(["exports","regl","maptalks"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TerrainLayer={},e.createREGL,e.maptalks)}(this,(function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=n(t),i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var l="undefined"!=typeof Float32Array?Float32Array:Array;function s(){var e=new l(3);return l!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function u(e,t,r){var n=new l(3);return n[0]=e,n[1]=t,n[2]=r,n}function c(e,t,r){var n=t[0],a=t[1],i=t[2],o=r[0],l=r[1],s=r[2];return e[0]=a*s-i*l,e[1]=i*o-n*s,e[2]=n*l-a*o,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var p,h=function(e){var t=e[0],r=e[1],n=e[2];return Math.hypot(t,r,n)};p=s();!function(){var e,t=(e=new l(4),l!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function f(){var e=new l(4);return l!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function v(e,t,r,n){var a,i,o,l,s,u=t[0],c=t[1],p=t[2],h=t[3],f=r[0],v=r[1],d=r[2],g=r[3];return(i=u*f+c*v+p*d+h*g)<0&&(i=-i,f=-f,v=-v,d=-d,g=-g),1-i>1e-6?(a=Math.acos(i),o=Math.sin(a),l=Math.sin((1-n)*a)/o,s=Math.sin(n*a)/o):(l=1-n,s=n),e[0]=l*u+s*f,e[1]=l*c+s*v,e[2]=l*p+s*d,e[3]=l*h+s*g,e}var d,g,y,_,m,w,x,C=function(e,t){var r=t[0],n=t[1],a=t[2],i=t[3],o=r*r+n*n+a*a+i*i;return o>0&&(o=1/Math.sqrt(o)),e[0]=r*o,e[1]=n*o,e[2]=a*o,e[3]=i*o,e};d=s(),g=u(1,0,0),y=u(0,1,0),_=f(),m=f(),w=new l(9),l!=Float32Array&&(w[1]=0,w[2]=0,w[3]=0,w[5]=0,w[6]=0,w[7]=0),w[0]=1,w[4]=1,w[8]=1,x=w;!function(){var e=function(){var e=new l(2);return l!=Float32Array&&(e[0]=0,e[1]=0),e}()}();var T=1;"undefined"!=typeof window&&(T=window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI),registerLoaders([[ImageLoader,{imagebitmap:{premultiplyAlpha:"none"}}]]);var b={registerEvents:!0,renderer:"gl",glOptions:{alpha:!0,depth:!1,antialias:!0,stencil:!0},forceRenderOnMoving:!0,forceRenderOnZooming:!0,elevationDecoder:{rScaler:6553.6,gScaler:25.6,bScaler:.1,offset:-1e4},meshMaxError:4,workerUrl:null},z=function(e){function t(t,r){return void 0===r&&(r={}),e.call(this,t,Object.assign({},b,r))||this}return o(t,e),t.prototype.rerender=function(){var e=this.getRenderer();e&&e.setToRedraw()},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.getTileSize=function(){return e.prototype.getTileSize.call(this)},t}(r.TileLayer),L=new Float32Array([0,0,0]),M=new Float32Array(16),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.isDrawable=function(){return!0},t.prototype._drawTiles=function(t,r,n,a){e.prototype._drawTiles.call(this,t,r,n,a),this.regl&&this.regl._refresh()},t.prototype.loadTile=function(e){var t=this,r=this.layer.options,n=r.terrainTiles,a=r.elevationDecoder,i=r.meshMaxError,o=r.workerUrl;if(n){var l=function(e,t){if(!e||!e.length)return null;Array.isArray(e)&&(e=e[Math.abs(t.x+t.y)%e.length]);var r=t.x,n=t.y,a=t.z;return e.replace("{x}",String(r)).replace("{y}",String(n)).replace("{z}",String(a)).replace("{-y}",String(Math.pow(2,a)-n-1))}(n,{x:e.x,y:e.y,z:e.z});return Promise.all([this.loadTerrain({elevationData:l,bounds:[0,0,1,1],elevationDecoder:a,meshMaxError:i,workerUrl:o}),load(e.url,[ImageLoader])]).then((function(r){var n=r[0],a=r[1];e.terrainData=n,t.onTileLoad(a,e)})).catch((function(r){console.error(r),t.onTileError("",e)})),{}}return console.warn("必须指定真实渲染图层: options.terrainTiles"),{}},t.prototype.onTileLoad=function(t,r){return e.prototype.onTileLoad.call(this,t,r)},t.prototype.loadTerrain=function(e){var t=e.elevationData,r=e.bounds,n=e.elevationDecoder,a=e.meshMaxError,i=e.workerUrl;if(!t)return null;var o={terrain:{bounds:r,meshMaxError:a,elevationDecoder:n}};return null!==i&&(o.terrain.workerUrl=i),load(t,TerrainLoader,o)},t.prototype.drawTile=function(e,t){var r=this.getMap();if(e&&r&&t&&this.regl&&this.command){var n=e._glScale=e._glScale||r.getGLScale(e.z),a=e.size[0];e.size[1];e.cache,e.u_tile||(e.u_tile=this.regl.texture({data:t,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!0}));var i=e.point,o=i.x*n,l=i.y*n;L[0]=o||0,L[1]=l||0;var s=this.layer.options,u=s.extrudeScale,c=s.opacity,p=this.getTileOpacity(t),h=this.getMap().projViewMatrix;if(!e.planeBuffer){var f=e.terrainData,v=f.attributes,d=f.indices;e.planeBuffer={elements:this.regl.elements({data:d.value,primitive:"triangles",type:"uint32"}),position:{buffer:this.regl.buffer({data:v.POSITION.value,type:"float"}),size:v.POSITION.size},uvs:{buffer:this.regl.buffer(v.TEXCOORD_0.value),size:v.TEXCOORD_0.size}}}var g=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(M);!function(e,t,r){var n,a,i,o,l,s,u,c,p,h,f,v,d=r[0],g=r[1],y=r[2];t===e?(e[12]=t[0]*d+t[4]*g+t[8]*y+t[12],e[13]=t[1]*d+t[5]*g+t[9]*y+t[13],e[14]=t[2]*d+t[6]*g+t[10]*y+t[14],e[15]=t[3]*d+t[7]*g+t[11]*y+t[15]):(n=t[0],a=t[1],i=t[2],o=t[3],l=t[4],s=t[5],u=t[6],c=t[7],p=t[8],h=t[9],f=t[10],v=t[11],e[0]=n,e[1]=a,e[2]=i,e[3]=o,e[4]=l,e[5]=s,e[6]=u,e[7]=c,e[8]=p,e[9]=h,e[10]=f,e[11]=v,e[12]=n*d+l*g+p*y+t[12],e[13]=a*d+s*g+h*y+t[13],e[14]=i*d+u*g+f*y+t[14],e[15]=o*d+c*g+v*y+t[15])}(g,g,L),function(e,t,r){var n=r[0],a=r[1],i=r[2];e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*a,e[5]=t[5]*a,e[6]=t[6]*a,e[7]=t[7]*a,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(g,g,[n,n,1]),function(e,t,r){var n=t[0],a=t[1],i=t[2],o=t[3],l=t[4],s=t[5],u=t[6],c=t[7],p=t[8],h=t[9],f=t[10],v=t[11],d=t[12],g=t[13],y=t[14],_=t[15],m=r[0],w=r[1],x=r[2],C=r[3];e[0]=m*n+w*l+x*p+C*d,e[1]=m*a+w*s+x*h+C*g,e[2]=m*i+w*u+x*f+C*y,e[3]=m*o+w*c+x*v+C*_,m=r[4],w=r[5],x=r[6],C=r[7],e[4]=m*n+w*l+x*p+C*d,e[5]=m*a+w*s+x*h+C*g,e[6]=m*i+w*u+x*f+C*y,e[7]=m*o+w*c+x*v+C*_,m=r[8],w=r[9],x=r[10],C=r[11],e[8]=m*n+w*l+x*p+C*d,e[9]=m*a+w*s+x*h+C*g,e[10]=m*i+w*u+x*f+C*y,e[11]=m*o+w*c+x*v+C*_,m=r[12],w=r[13],x=r[14],C=r[15],e[12]=m*n+w*l+x*p+C*d,e[13]=m*a+w*s+x*h+C*g,e[14]=m*i+w*u+x*f+C*y,e[15]=m*o+w*c+x*v+C*_}(g,h,g),this.command({u_matrix:g,u_tile:e.u_tile,u_tile_size:a,zoom:e.z,elements:e.planeBuffer.elements,a_pos:e.planeBuffer.position,a_texCoord:e.planeBuffer.uvs,u_opacity:void 0!==c?c:1,u_extrude_scale:void 0!==u?u:1,canvasSize:[this.gl.canvas.width,this.gl.canvas.height]}),p<1?this.setToRedraw():this.setCanvasUpdated()}},t.prototype.getCanvasImage=function(){if(!this.regl||!this.canvas2)return e.prototype.getCanvasImage.call(this);var t=e.prototype.getCanvasImage.call(this);return t&&(t.image=this.canvas2),t},t.prototype.onCanvasCreate=function(){var e,t;(null===(e=this.canvas)||void 0===e?void 0:e.gl)&&(null===(t=this.canvas)||void 0===t?void 0:t.gl.wrap)||(this.canvas2=r.Canvas.createCanvas(this.canvas.width,this.canvas.height))},t.prototype.createContext=function(){var t,r,n,i,o,l;if(e.prototype.createContext.call(this),(null===(t=this.canvas)||void 0===t?void 0:t.gl)&&(null===(r=this.canvas)||void 0===r?void 0:r.gl.wrap))this.gl=null===(n=this.canvas)||void 0===n?void 0:n.gl.wrap();else{var s=this.layer,u=(null===(i=s.options)||void 0===i?void 0:i.glOptions)||{alpha:!0,depth:!0,antialias:!0,stencil:!0};u.preserveDrawingBuffer=!0,(null===(o=s.options)||void 0===o?void 0:o.customCreateGLContext)?this.gl=this.gl||(null===(l=s.options)||void 0===l?void 0:l.customCreateGLContext(this.canvas2,u)):this.gl=this.gl||function(e,t){if(void 0===t&&(t={}),!e)return null;function r(e){console.log(e.statusMessage)}e&&e.addEventListener&&e.addEventListener("webglcontextcreationerror",r,!1);var n=e.getContext("webgl",t);return(n=n||e.getContext("experimental-webgl",t))||(n=(n=e.getContext("webgl",t))||e.getContext("experimental-webgl",t)),e.removeEventListener&&e.removeEventListener("webglcontextcreationerror",r,!1),n}(this.canvas2,u),this.regl||(this.regl=a.default({gl:this.gl,extensions:["OES_texture_float","OES_element_index_uint","WEBGL_color_buffer_float"],attributes:{antialias:!0,preserveDrawingBuffer:!1}}),this.command=this.regl({frag:"precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texCoord;varying float v_height;uniform sampler2D u_tile;uniform float u_opacity;void main(){vec4 color=texture2D(u_tile,v_texCoord);gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}",vert:"#define GLSLIFY 1\nattribute vec3 a_pos;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform float u_tile_size;uniform float u_extrude_scale;varying vec2 v_texCoord;varying float v_height;void main(){v_texCoord=a_texCoord;v_height=a_pos.z;gl_Position=u_matrix*vec4(a_pos.x*u_tile_size,(a_pos.y-1.0)*u_tile_size,a_pos.z*u_extrude_scale,1.0);}",attributes:{a_pos:function(e,t){var r=t.a_pos;return r},a_texCoord:function(e,t){var r=t.a_texCoord;return r}},uniforms:{u_matrix:function(e,t){var r=t.u_matrix;return r},u_tile:function(e,t){var r=t.u_tile;return r},u_tile_size:function(e,t){var r=t.u_tile_size;return r},u_opacity:function(e,t){var r=t.u_opacity;return r},u_extrude_scale:function(e,t){var r=t.u_extrude_scale;return r}},viewport:function(e,t){var r=t.canvasSize;return{width:r[0],height:r[1]}},depth:{enable:!0,mask:!0,func:"less",range:[0,1]},stencil:{enable:!0,func:{cmp:"<=",ref:function(e,t){return t.zoom},mask:255}},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},color:[0,0,0,0]},elements:function(e,t){var r=t.elements;return r}}))}},t.prototype.resizeCanvas=function(e){if(this.canvas){var t=this.getMap(),r=(t.getDevicePixelRatio?t.getDevicePixelRatio():T)||1,n=e||t.getSize();this.canvas.width===n.width*r&&this.canvas.height===n.height*r||(this.canvas.height=r*n.height,this.canvas.width=r*n.width),this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.height=this.canvas.height,this.canvas2.width=this.canvas.width)}},t.prototype.clearCanvas=function(){this.canvas&&this.gl&&(e.prototype.clearCanvas.call(this),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:this._tileZoom}))},t.prototype.clear=function(){this._retireTiles(!0);for(var t=this.tileCache.keys(),r=0,n=t.length;r<n;r++){var a=this.tileCache.get(t[r]);a.info&&(a.info.u_tile&&a.info.u_tile.destroy(),a.info.planeBuffer&&(a.info.planeBuffer.elements.destroy(),a.info.planeBuffer.position.buffer.destroy(),a.info.planeBuffer.uvs.buffer.destroy()))}this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],e.prototype.clear.call(this)},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.onRemove=function(){e.prototype.onRemove.call(this)},t.prototype.completeRender=function(){return e.prototype.completeRender.call(this)},t.prototype.setCanvasUpdated=function(){return e.prototype.setCanvasUpdated.call(this)},t.prototype.setToRedraw=function(){return e.prototype.setToRedraw.call(this)},t.prototype.prepareCanvas=function(){return e.prototype.prepareCanvas.call(this)},t.prototype.getTileOpacity=function(t){return e.prototype.getTileOpacity.call(this,t)},t}(r.renderer.TileLayerCanvasRenderer);z.registerRenderer("gl",O),e.Renderer=O,e.default=z,Object.defineProperty(e,"__esModule",{value:!0})})),"undefined"!=typeof window&&window.TerrainLayer&&(window.TerrainLayer=window.TerrainLayer.default);
