/*!
 * author: sakitam-fdd <smilefdd@gmail.com>
 * maptalks-regl v1.0.0
 * build-time: 2021-1-12 12:7
 * LICENSE: MIT
 * (c) 2020-2021 https://github.com/sakitam-gis/simple-terrain-viz
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("regl"),require("maptalks")):"function"==typeof define&&define.amd?define(["exports","regl","maptalks"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TerrainLayer={},e.createREGL,e.maptalks)}(this,(function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=n(t),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var s="undefined"!=typeof Float32Array?Float32Array:Array;function l(){var e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function u(e,t,r){var n=new s(3);return n[0]=e,n[1]=t,n[2]=r,n}function c(e,t,r){var n=t[0],i=t[1],a=t[2],o=r[0],s=r[1],l=r[2];return e[0]=i*l-a*s,e[1]=a*o-n*l,e[2]=n*s-i*o,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var p,h=function(e){var t=e[0],r=e[1],n=e[2];return Math.hypot(t,r,n)};p=l();!function(){var e,t=(e=new s(4),s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function v(){var e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function g(e,t,r,n){var i,a,o,s,l,u=t[0],c=t[1],p=t[2],h=t[3],v=r[0],g=r[1],f=r[2],d=r[3];return(a=u*v+c*g+p*f+h*d)<0&&(a=-a,v=-v,g=-g,f=-f,d=-d),1-a>1e-6?(i=Math.acos(a),o=Math.sin(i),s=Math.sin((1-n)*i)/o,l=Math.sin(n*i)/o):(s=1-n,l=n),e[0]=s*u+l*v,e[1]=s*c+l*g,e[2]=s*p+l*f,e[3]=s*h+l*d,e}var f,d,y,m,_,w,x,C=function(e,t){var r=t[0],n=t[1],i=t[2],a=t[3],o=r*r+n*n+i*i+a*a;return o>0&&(o=1/Math.sqrt(o)),e[0]=r*o,e[1]=n*o,e[2]=i*o,e[3]=a*o,e};f=l(),d=u(1,0,0),y=u(0,1,0),m=v(),_=v(),w=new s(9),s!=Float32Array&&(w[1]=0,w[2]=0,w[3]=0,w[5]=0,w[6]=0,w[7]=0),w[0]=1,w[4]=1,w[8]=1,x=w;!function(){var e=function(){var e=new s(2);return s!=Float32Array&&(e[0]=0,e[1]=0),e}()}();var b=1;"undefined"!=typeof window&&(b=window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI);var T={registerEvents:!0,renderer:"gl",glOptions:{alpha:!0,depth:!0,antialias:!0,stencil:!0},forceRenderOnMoving:!0,forceRenderOnZooming:!0},S=function(e){function t(t,r){return void 0===r&&(r={}),e.call(this,t,Object.assign({},T,r))||this}return o(t,e),t.prototype.rerender=function(){var e=this.getRenderer();e&&e.setToRedraw()},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.getTileSize=function(){return e.prototype.getTileSize.call(this)},t}(r.TileLayer),M=new Float32Array([0,0,0]),L=new Float32Array(16),O=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.isDrawable=function(){return!0},t.prototype._drawTiles=function(t,r,n,i){e.prototype._drawTiles.call(this,t,r,n,i),this.regl&&this.regl._refresh()},t.prototype.getPlaneBuffer=function(e,t,r,n,i,a,o){if(e.planeBuffer&&e.widthSegments===a&&e.heightSegments===o)return e.planeBuffer;e.widthSegments=a,e.heightSegments=o;for(var s=n/2,l=i/2,u=Math.floor(a),c=Math.floor(o),p=u+1,h=c+1,v=n/u,g=i/c,f=[],d=[],y=[],m=0;m<h;m++)for(var _=m*g,w=0;w<p;w++){var x=w*v;d.push(t+x/s/2*n,r-_/l/2*i),y.push(x/s/2,_/l/2)}for(m=0;m<c;m++)for(w=0;w<u;w++){var C=w+p*m,b=w+p*(m+1),T=w+1+p*(m+1),S=w+1+p*m;f.push(C,b,S),f.push(b,T,S)}return e.planeBuffer={uvs:y,vertices:d,indices:f,elements:this.regl.elements({data:f,primitive:"triangles",type:"uint32",count:f.length}),position:{buffer:this.regl.buffer({data:d,type:"float"}),size:2}},e.planeBuffer},t.prototype.loadTile=function(e){var t=this,r=this.layer.getTileSize(),n=this.layer.options,i=n.realTiles,a=n.crossOrigin,o=new Image;if(i){var s=function(e,t){if(!e||!e.length)return null;Array.isArray(e)&&(e=e[Math.abs(t.x+t.y)%e.length]);var r=t.x,n=t.y,i=t.z;return e.replace("{x}",String(r)).replace("{y}",String(n)).replace("{z}",String(i)).replace("{-y}",String(Math.pow(2,i)-n-1))}(i,{x:e.x,y:e.y,z:e.z}),l=new Image;o.width=r.width,o.height=r.height,o.onload=function(){e.displayImage=l,l.onload=t.onTileLoad.bind(t,o,e),s&&(l.src=s),l.crossOrigin=null!==a?a:"*"}}else console.warn("必须指定真实渲染图层: options.realTiles");return o.onerror=this.onTileError.bind(this,o,e),this.loadTileImage(o,e.url),o},t.prototype.drawTile=function(e,t){var r=this.getMap();if(e&&r&&t&&this.regl&&this.command){var n=e._glScale=e._glScale||r.getGLScale(e.z),i=e.size[0],a=e.size[1];e.cache,e.u_image||(e.u_image=this.regl.texture({data:t,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!1})),e.u_tile||(e.u_tile=this.regl.texture({data:e.displayImage,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!1}));var o=e.point,s=o.x*n,l=o.y*n;M[0]=s||0,M[1]=l||0;var u=this.layer.options,c=u.extrudeScale,p=u.widthSegments,h=u.heightSegments,v=u.opacity,g=this.getTileOpacity(t),f=this.getMap().projViewMatrix;e.planeBuffer;var d=this.getPlaneBuffer(e,0,0,i,a,void 0!==p?p:i/2,void 0!==h?h:a/2),y=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(L);!function(e,t,r){var n,i,a,o,s,l,u,c,p,h,v,g,f=r[0],d=r[1],y=r[2];t===e?(e[12]=t[0]*f+t[4]*d+t[8]*y+t[12],e[13]=t[1]*f+t[5]*d+t[9]*y+t[13],e[14]=t[2]*f+t[6]*d+t[10]*y+t[14],e[15]=t[3]*f+t[7]*d+t[11]*y+t[15]):(n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],p=t[8],h=t[9],v=t[10],g=t[11],e[0]=n,e[1]=i,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=p,e[9]=h,e[10]=v,e[11]=g,e[12]=n*f+s*d+p*y+t[12],e[13]=i*f+l*d+h*y+t[13],e[14]=a*f+u*d+v*y+t[14],e[15]=o*f+c*d+g*y+t[15])}(y,y,M),function(e,t,r){var n=r[0],i=r[1],a=r[2];e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(y,y,[n,n,1]),function(e,t,r){var n=t[0],i=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],p=t[8],h=t[9],v=t[10],g=t[11],f=t[12],d=t[13],y=t[14],m=t[15],_=r[0],w=r[1],x=r[2],C=r[3];e[0]=_*n+w*s+x*p+C*f,e[1]=_*i+w*l+x*h+C*d,e[2]=_*a+w*u+x*v+C*y,e[3]=_*o+w*c+x*g+C*m,_=r[4],w=r[5],x=r[6],C=r[7],e[4]=_*n+w*s+x*p+C*f,e[5]=_*i+w*l+x*h+C*d,e[6]=_*a+w*u+x*v+C*y,e[7]=_*o+w*c+x*g+C*m,_=r[8],w=r[9],x=r[10],C=r[11],e[8]=_*n+w*s+x*p+C*f,e[9]=_*i+w*l+x*h+C*d,e[10]=_*a+w*u+x*v+C*y,e[11]=_*o+w*c+x*g+C*m,_=r[12],w=r[13],x=r[14],C=r[15],e[12]=_*n+w*s+x*p+C*f,e[13]=_*i+w*l+x*h+C*d,e[14]=_*a+w*u+x*v+C*y,e[15]=_*o+w*c+x*g+C*m}(y,f,y),this.command({u_matrix:y,u_image:e.u_image,u_tile:e.u_tile,elements:d.elements,a_pos:d.position,a_texCoord:d.uvs,u_opacity:void 0!==v?v:1,u_extrude_scale:void 0!==c?c:1,canvasSize:[this.gl.canvas.width,this.gl.canvas.height]}),g<1?this.setToRedraw():this.setCanvasUpdated()}},t.prototype.loadTileImage=function(e,t){var r=this.layer.options.crossOrigin;e.crossOrigin=null!==r?r:"",e.src=t},t.prototype.getCanvasImage=function(){if(!this.regl||!this.canvas2)return e.prototype.getCanvasImage.call(this);var t=e.prototype.getCanvasImage.call(this);return t&&(t.image=this.canvas2),t},t.prototype.onCanvasCreate=function(){var e,t;(null===(e=this.canvas)||void 0===e?void 0:e.gl)&&(null===(t=this.canvas)||void 0===t?void 0:t.gl.wrap)||(this.canvas2=r.Canvas.createCanvas(this.canvas.width,this.canvas.height))},t.prototype.createContext=function(){var t,r,n,a,o,s;if(e.prototype.createContext.call(this),(null===(t=this.canvas)||void 0===t?void 0:t.gl)&&(null===(r=this.canvas)||void 0===r?void 0:r.gl.wrap))this.gl=null===(n=this.canvas)||void 0===n?void 0:n.gl.wrap();else{var l=this.layer,u=(null===(a=l.options)||void 0===a?void 0:a.glOptions)||{alpha:!0,depth:!0,antialias:!0,stencil:!0};u.preserveDrawingBuffer=!0,(null===(o=l.options)||void 0===o?void 0:o.customCreateGLContext)?this.gl=this.gl||(null===(s=l.options)||void 0===s?void 0:s.customCreateGLContext(this.canvas2,u)):this.gl=this.gl||function(e,t){if(void 0===t&&(t={}),!e)return null;function r(e){console.log(e.statusMessage)}e&&e.addEventListener&&e.addEventListener("webglcontextcreationerror",r,!1);var n=e.getContext("webgl",t);return(n=n||e.getContext("experimental-webgl",t))||(n=(n=e.getContext("webgl",t))||e.getContext("experimental-webgl",t)),e.removeEventListener&&e.removeEventListener("webglcontextcreationerror",r,!1),n}(this.canvas2,u),this.regl||(this.regl=i.default({gl:this.gl,extensions:["OES_texture_float","OES_element_index_uint","WEBGL_color_buffer_float"],attributes:{antialias:!0,preserveDrawingBuffer:!1}}),this.command=this.regl({frag:"precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texCoord;varying float v_height;uniform sampler2D u_tile;uniform float u_opacity;void main(){vec4 color=texture2D(u_tile,v_texCoord);gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}",vert:"#define GLSLIFY 1\nattribute vec2 a_pos;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform sampler2D u_image;uniform float u_extrude_scale;varying vec2 v_texCoord;varying float v_height;void main(){v_texCoord=a_texCoord;vec3 rgb=texture2D(u_image,v_texCoord).rgb;float height=-10000.0+((rgb.r*255.0*256.0*256.0+rgb.g*255.0*256.0+rgb.b*255.0)*0.1);v_height=height;gl_Position=u_matrix*vec4(a_pos.xy,height*u_extrude_scale,1.0);}",attributes:{a_pos:function(e,t){var r=t.a_pos;return r},a_texCoord:function(e,t){var r=t.a_texCoord;return r}},uniforms:{u_matrix:function(e,t){var r=t.u_matrix;return r},u_image:function(e,t){var r=t.u_image;return r},u_tile:function(e,t){var r=t.u_tile;return r},u_opacity:function(e,t){var r=t.u_opacity;return r},u_extrude_scale:function(e,t){var r=t.u_extrude_scale;return r}},viewport:function(e,t){var r=t.canvasSize;return{width:r[0],height:r[1]}},depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},color:[0,0,0,0]},elements:function(e,t){var r=t.elements;return r}}))}},t.prototype.resizeCanvas=function(e){if(this.canvas){var t=this.getMap(),r=(t.getDevicePixelRatio?t.getDevicePixelRatio():b)||1,n=e||t.getSize();this.canvas.width===n.width*r&&this.canvas.height===n.height*r||(this.canvas.height=r*n.height,this.canvas.width=r*n.width),this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.height=this.canvas.height,this.canvas2.width=this.canvas.width)}},t.prototype.clearCanvas=function(){this.canvas&&this.gl&&(e.prototype.clearCanvas.call(this),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1}))},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.onRemove=function(){e.prototype.onRemove.call(this)},t.prototype.completeRender=function(){return e.prototype.completeRender.call(this)},t.prototype.setCanvasUpdated=function(){return e.prototype.setCanvasUpdated.call(this)},t.prototype.setToRedraw=function(){return e.prototype.setToRedraw.call(this)},t.prototype.prepareCanvas=function(){return e.prototype.prepareCanvas.call(this)},t.prototype.getTileOpacity=function(t){return e.prototype.getTileOpacity.call(this,t)},t}(r.renderer.TileLayerCanvasRenderer);S.registerRenderer("gl",O),e.Renderer=O,e.default=S,Object.defineProperty(e,"__esModule",{value:!0})})),"undefined"!=typeof window&&window.TerrainLayer&&(window.TerrainLayer=window.TerrainLayer.default);
