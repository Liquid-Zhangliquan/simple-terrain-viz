/*!
 * author: sakitam-fdd <smilefdd@gmail.com>
 * maptalks-regl v1.0.0
 * build-time: 2021-1-14 15:33
 * LICENSE: MIT
 * (c) 2020-2021 https://github.com/sakitam-gis/simple-terrain-viz
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("regl"),require("maptalks")):"function"==typeof define&&define.amd?define(["exports","regl","maptalks"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).TerrainLayer={},e.createREGL,e.maptalks)}(this,(function(e,t,r){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=i(t),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var s="undefined"!=typeof Float32Array?Float32Array:Array;function l(){var e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function u(e,t,r){var i=new s(3);return i[0]=e,i[1]=t,i[2]=r,i}function c(e,t,r){var i=t[0],n=t[1],a=t[2],o=r[0],s=r[1],l=r[2];return e[0]=n*l-a*s,e[1]=a*o-i*l,e[2]=i*s-n*o,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var p,h=function(e){var t=e[0],r=e[1],i=e[2];return Math.hypot(t,r,i)};p=l();!function(){var e,t=(e=new s(4),s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();function g(){var e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function v(e,t,r,i){var n,a,o,s,l,u=t[0],c=t[1],p=t[2],h=t[3],g=r[0],v=r[1],f=r[2],d=r[3];return(a=u*g+c*v+p*f+h*d)<0&&(a=-a,g=-g,v=-v,f=-f,d=-d),1-a>1e-6?(n=Math.acos(a),o=Math.sin(n),s=Math.sin((1-i)*n)/o,l=Math.sin(i*n)/o):(s=1-i,l=i),e[0]=s*u+l*g,e[1]=s*c+l*v,e[2]=s*p+l*f,e[3]=s*h+l*d,e}var f,d,y,m,_,w,x,T=function(e,t){var r=t[0],i=t[1],n=t[2],a=t[3],o=r*r+i*i+n*n+a*a;return o>0&&(o=1/Math.sqrt(o)),e[0]=r*o,e[1]=i*o,e[2]=n*o,e[3]=a*o,e};f=l(),d=u(1,0,0),y=u(0,1,0),m=g(),_=g(),w=new s(9),s!=Float32Array&&(w[1]=0,w[2]=0,w[3]=0,w[5]=0,w[6]=0,w[7]=0),w[0]=1,w[4]=1,w[8]=1,x=w;!function(){var e=function(){var e=new s(2);return s!=Float32Array&&(e[0]=0,e[1]=0),e}()}();var C=1;"undefined"!=typeof window&&(C=window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI);var b={registerEvents:!0,renderer:"gl",glOptions:{alpha:!0,depth:!1,antialias:!0,stencil:!0},forceRenderOnMoving:!0,forceRenderOnZooming:!0},S=function(e){function t(t,r){return void 0===r&&(r={}),e.call(this,t,Object.assign({},b,r))||this}return o(t,e),t.prototype.rerender=function(){var e=this.getRenderer();e&&e.setToRedraw()},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.getTileSize=function(){return e.prototype.getTileSize.call(this)},t}(r.TileLayer),z=new Float32Array([0,0,0]),M=new Float32Array(16),L=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t.prototype.isDrawable=function(){return!0},t.prototype._drawTiles=function(t,r,i,n){e.prototype._drawTiles.call(this,t,r,i,n),this.regl&&this.regl._refresh()},t.prototype.getPlaneBuffer=function(e,t,r,i,n,a,o){if(e.planeBuffer&&e.widthSegments===a&&e.heightSegments===o)return e.planeBuffer;e.widthSegments=a,e.heightSegments=o;for(var s=i/2,l=n/2,u=Math.floor(a),c=Math.floor(o),p=u+1,h=c+1,g=i/u,v=n/c,f=[],d=[],y=[],m=0;m<h;m++)for(var _=m*v,w=0;w<p;w++){var x=w*g;d.push(x/s/2,-_/l/2),y.push(x/s/2,_/l/2)}for(m=0;m<c;m++)for(w=0;w<u;w++){var T=w+p*m,C=w+p*(m+1),b=w+1+p*(m+1),S=w+1+p*m;f.push(T,C,S),f.push(C,b,S)}return e.planeBuffer={uvs:y,vertices:d,indices:f,elements:this.regl.elements({data:f,primitive:"triangles",type:"uint32",count:f.length}),position:{buffer:this.regl.buffer({data:d,type:"float"}),size:2}},e.planeBuffer},t.prototype.loadTile=function(e){var t=this,r=this.layer.getTileSize(),i=this.layer.options,n=i.terrainTiles,a=i.crossOrigin;if(n){var o=function(e,t){if(!e||!e.length)return null;Array.isArray(e)&&(e=e[Math.abs(t.x+t.y)%e.length]);var r=t.x,i=t.y,n=t.z;return e.replace("{x}",String(r)).replace("{y}",String(i)).replace("{z}",String(n)).replace("{-y}",String(Math.pow(2,n)-i-1))}(n,{x:e.x,y:e.y,z:e.z}),s=new Image,l=new Image;return l.width=r.width,l.height=r.height,l.onload=function(){t.onTileLoad(l,e),s.onload=function(){e.terrainImage=s,t.onTileLoad(l,e)},s.onerror=t.onTileError.bind(t,l,e),s.crossOrigin=null!==a?a:"*",o&&(s.src=o)},l.onerror=this.onTileError.bind(this,l,e),this.loadTileImage(l,e.url),l}console.warn("必须指定真实渲染图层: options.terrainTiles")},t.prototype.onTileLoad=function(t,r){return e.prototype.onTileLoad.call(this,t,r)},t.prototype.drawTile=function(e,t){var r=this.getMap();if(e&&r&&t&&this.regl&&this.command){var i=e._glScale=e._glScale||r.getGLScale(e.z),n=e.size[0],a=e.size[1];e.cache,e.u_tile||(e.u_tile=this.regl.texture({data:t,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!0})),!e.hasTerrain&&e.terrainImage?(e.u_image&&e.u_image.destroy(),e.u_image=this.regl.texture({data:e.terrainImage,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!0}),e.hasTerrain=!0):e.hasTerrain||e.terrainImage||(e.u_image=this.regl.texture({width:n,height:a,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear"}),e.hasTerrain=!1);var o=e.point,s=o.x*i,l=o.y*i;z[0]=s||0,z[1]=l||0;var u=this.layer.options,c=u.extrudeScale,p=u.widthSegments,h=u.heightSegments,g=u.opacity,v=this.getTileOpacity(t),f=this.getMap().projViewMatrix,d=this.getPlaneBuffer(e,0,0,n,a,void 0!==p?p:n/2,void 0!==h?h:a/2),y=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(M);!function(e,t,r){var i,n,a,o,s,l,u,c,p,h,g,v,f=r[0],d=r[1],y=r[2];t===e?(e[12]=t[0]*f+t[4]*d+t[8]*y+t[12],e[13]=t[1]*f+t[5]*d+t[9]*y+t[13],e[14]=t[2]*f+t[6]*d+t[10]*y+t[14],e[15]=t[3]*f+t[7]*d+t[11]*y+t[15]):(i=t[0],n=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],p=t[8],h=t[9],g=t[10],v=t[11],e[0]=i,e[1]=n,e[2]=a,e[3]=o,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=p,e[9]=h,e[10]=g,e[11]=v,e[12]=i*f+s*d+p*y+t[12],e[13]=n*f+l*d+h*y+t[13],e[14]=a*f+u*d+g*y+t[14],e[15]=o*f+c*d+v*y+t[15])}(y,y,z),function(e,t,r){var i=r[0],n=r[1],a=r[2];e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*a,e[9]=t[9]*a,e[10]=t[10]*a,e[11]=t[11]*a,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(y,y,[i,i,1]),function(e,t,r){var i=t[0],n=t[1],a=t[2],o=t[3],s=t[4],l=t[5],u=t[6],c=t[7],p=t[8],h=t[9],g=t[10],v=t[11],f=t[12],d=t[13],y=t[14],m=t[15],_=r[0],w=r[1],x=r[2],T=r[3];e[0]=_*i+w*s+x*p+T*f,e[1]=_*n+w*l+x*h+T*d,e[2]=_*a+w*u+x*g+T*y,e[3]=_*o+w*c+x*v+T*m,_=r[4],w=r[5],x=r[6],T=r[7],e[4]=_*i+w*s+x*p+T*f,e[5]=_*n+w*l+x*h+T*d,e[6]=_*a+w*u+x*g+T*y,e[7]=_*o+w*c+x*v+T*m,_=r[8],w=r[9],x=r[10],T=r[11],e[8]=_*i+w*s+x*p+T*f,e[9]=_*n+w*l+x*h+T*d,e[10]=_*a+w*u+x*g+T*y,e[11]=_*o+w*c+x*v+T*m,_=r[12],w=r[13],x=r[14],T=r[15],e[12]=_*i+w*s+x*p+T*f,e[13]=_*n+w*l+x*h+T*d,e[14]=_*a+w*u+x*g+T*y,e[15]=_*o+w*c+x*v+T*m}(y,f,y),this.command({u_matrix:y,u_image:e.u_image,u_tile:e.u_tile,u_tile_size:n,u_hasTerrain:e.hasTerrain?1:0,zoom:e.z,elements:d.elements,a_pos:d.position,a_texCoord:d.uvs,u_opacity:void 0!==g?g:1,u_extrude_scale:void 0!==c?c:1,canvasSize:[this.gl.canvas.width,this.gl.canvas.height]}),v<1?this.setToRedraw():this.setCanvasUpdated()}},t.prototype.loadTileImage=function(e,t){var r=this.layer.options.crossOrigin;e.crossOrigin=null!==r?r:"",e.src=t},t.prototype.getCanvasImage=function(){if(!this.regl||!this.canvas2)return e.prototype.getCanvasImage.call(this);var t=e.prototype.getCanvasImage.call(this);return t&&(t.image=this.canvas2),t},t.prototype.onCanvasCreate=function(){var e,t;(null===(e=this.canvas)||void 0===e?void 0:e.gl)&&(null===(t=this.canvas)||void 0===t?void 0:t.gl.wrap)||(this.canvas2=r.Canvas.createCanvas(this.canvas.width,this.canvas.height))},t.prototype.createContext=function(){var t,r,i,a,o,s;if(e.prototype.createContext.call(this),(null===(t=this.canvas)||void 0===t?void 0:t.gl)&&(null===(r=this.canvas)||void 0===r?void 0:r.gl.wrap))this.gl=null===(i=this.canvas)||void 0===i?void 0:i.gl.wrap();else{var l=this.layer,u=(null===(a=l.options)||void 0===a?void 0:a.glOptions)||{alpha:!0,depth:!0,antialias:!0,stencil:!0};u.preserveDrawingBuffer=!0,(null===(o=l.options)||void 0===o?void 0:o.customCreateGLContext)?this.gl=this.gl||(null===(s=l.options)||void 0===s?void 0:s.customCreateGLContext(this.canvas2,u)):this.gl=this.gl||function(e,t){if(void 0===t&&(t={}),!e)return null;function r(e){console.log(e.statusMessage)}e&&e.addEventListener&&e.addEventListener("webglcontextcreationerror",r,!1);var i=e.getContext("webgl",t);return(i=i||e.getContext("experimental-webgl",t))||(i=(i=e.getContext("webgl",t))||e.getContext("experimental-webgl",t)),e.removeEventListener&&e.removeEventListener("webglcontextcreationerror",r,!1),i}(this.canvas2,u),this.regl||(this.regl=n.default({gl:this.gl,extensions:["OES_texture_float","OES_element_index_uint","WEBGL_color_buffer_float"],attributes:{antialias:!0,preserveDrawingBuffer:!1}}),this.command=this.regl({frag:"precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texCoord;varying float v_height;uniform sampler2D u_tile;uniform float u_opacity;void main(){vec4 color=texture2D(u_tile,v_texCoord);gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}",vert:"#define GLSLIFY 1\nattribute vec2 a_pos;attribute vec2 a_texCoord;uniform mat4 u_matrix;uniform float u_tile_size;uniform sampler2D u_image;uniform float u_extrude_scale;uniform float u_hasTerrain;varying vec2 v_texCoord;varying float v_height;void main(){v_texCoord=a_texCoord;if(u_hasTerrain>0.0){vec3 rgb=texture2D(u_image,v_texCoord).rgb;float height=-10000.0+((rgb.r*255.0*256.0*256.0+rgb.g*255.0*256.0+rgb.b*255.0)*0.1);v_height=height;gl_Position=u_matrix*vec4(a_pos.xy*u_tile_size,height*u_extrude_scale,1.0);}else{gl_Position=u_matrix*vec4(a_pos.xy*u_tile_size,0.0,1.0);}}",attributes:{a_pos:function(e,t){var r=t.a_pos;return r},a_texCoord:function(e,t){var r=t.a_texCoord;return r}},uniforms:{u_matrix:function(e,t){var r=t.u_matrix;return r},u_image:function(e,t){var r=t.u_image;return r},u_tile:function(e,t){var r=t.u_tile;return r},u_tile_size:function(e,t){var r=t.u_tile_size;return r},u_opacity:function(e,t){var r=t.u_opacity;return r},u_extrude_scale:function(e,t){var r=t.u_extrude_scale;return r},u_hasTerrain:function(e,t){var r=t.u_hasTerrain;return r}},viewport:function(e,t){var r=t.canvasSize;return{width:r[0],height:r[1]}},depth:{enable:!0,mask:!0,func:"less",range:[0,1]},stencil:{enable:!0,func:{cmp:"<=",ref:function(e,t){return t.zoom},mask:255}},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},color:[0,0,0,0]},elements:function(e,t){var r=t.elements;return r}}))}},t.prototype.resizeCanvas=function(e){if(this.canvas){var t=this.getMap(),r=(t.getDevicePixelRatio?t.getDevicePixelRatio():C)||1,i=e||t.getSize();this.canvas.width===i.width*r&&this.canvas.height===i.height*r||(this.canvas.height=r*i.height,this.canvas.width=r*i.width),this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.height=this.canvas.height,this.canvas2.width=this.canvas.width)}},t.prototype.clearCanvas=function(){this.canvas&&this.gl&&(e.prototype.clearCanvas.call(this),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:this._tileZoom}))},t.prototype.getMap=function(){return e.prototype.getMap.call(this)},t.prototype.onRemove=function(){e.prototype.onRemove.call(this)},t.prototype.completeRender=function(){return e.prototype.completeRender.call(this)},t.prototype.setCanvasUpdated=function(){return e.prototype.setCanvasUpdated.call(this)},t.prototype.setToRedraw=function(){return e.prototype.setToRedraw.call(this)},t.prototype.prepareCanvas=function(){return e.prototype.prepareCanvas.call(this)},t.prototype.getTileOpacity=function(t){return e.prototype.getTileOpacity.call(this,t)},t}(r.renderer.TileLayerCanvasRenderer);S.registerRenderer("gl",L),e.Renderer=L,e.default=S,Object.defineProperty(e,"__esModule",{value:!0})})),"undefined"!=typeof window&&window.TerrainLayer&&(window.TerrainLayer=window.TerrainLayer.default);
