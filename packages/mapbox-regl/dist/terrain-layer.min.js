/*!
 * author: sakitam-fdd <smilefdd@gmail.com>
 * mapbox-regl v1.0.0
 * build-time: 2021-1-13 17:42
 * LICENSE: MIT
 * (c) 2020-2021 https://github.com/sakitam-gis/simple-terrain-viz
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("regl")):"function"==typeof define&&define.amd?define(["regl"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).TerrainLayer=t(e.createREGL)}(this,(function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=t(e),r=function(){return(r=Object.assign||function(e){for(var t,i=1,r=arguments.length;i<r;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};return function(){function e(e,t,i){void 0===i&&(i={}),this.map=null,this.gl=null,this.id=e,this.tileSource=null,this.terrainTileSource=null,this.terrainSource=this.id+"terrainSource",this.source=this.id+"Source",this.type="custom",this.renderingMode="3d",this.tileJson=t,this.options=i,this.move=this.move.bind(this),this.onData=this.onData.bind(this),this.onTerrainData=this.onTerrainData.bind(this)}return e.prototype.createTerrain=function(){this.map.addSource(this.terrainSource,r(r({},this.tileJson),{tiles:this.tileJson.terrainTiles})),this.terrainTileSource=this.map.getSource(this.terrainSource),this.terrainTileSource&&(this.terrainTileSource.on("data",this.onTerrainData),this.terrainSourceCache=this.map.style.sourceCaches[this.terrainSource]),this.map.style._layers[this.id].source=this.terrainSource},e.prototype.createTile=function(){if(this.map){this.map.addSource(this.source,r(r({},this.tileJson),{tiles:this.tileJson.realTiles})),this.tileSource=this.map.getSource(this.source),this.tileSource&&(this.tileSource.on("data",this.onData),this.sourceCache=this.map.style.sourceCaches[this.source]);var e={id:this.id+"inner",type:"custom",renderingMode:"3d",onAdd:function(){},render:function(){},onRemove:function(){}};this.map.addLayer(e),this.map.style._layers[this.id+"inner"].source=this.source}},e.prototype.onAdd=function(e,t){this.map=e,this.gl=t,e.on("move",this.move),this.createTerrain(),this.createTile(),this.regl=i.default({gl:t,extensions:["OES_texture_float","OES_element_index_uint","WEBGL_color_buffer_float"],attributes:{antialias:!0,preserveDrawingBuffer:!1}}),this.command=this.regl({frag:"precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texCoord;varying float v_height;uniform sampler2D u_tile;uniform float u_opacity;void main(){vec4 color=texture2D(u_tile,v_texCoord);gl_FragColor=vec4(floor(255.0*color*u_opacity)/255.0);}",vert:"#define GLSLIFY 1\nattribute vec2 a_pos;uniform mat4 u_matrix;uniform sampler2D u_image;uniform float u_extrude_scale;varying vec2 v_texCoord;varying float v_height;float extent=4096.0*2.0;void main(){v_texCoord=a_pos;vec3 rgb=texture2D(u_image,v_texCoord).rgb;float height=-10000.0+((rgb.r*255.0*256.0*256.0+rgb.g*255.0*256.0+rgb.b*255.0)*0.1);v_height=height;gl_Position=u_matrix*vec4(a_pos.xy*extent,height*u_extrude_scale,1.0);}",attributes:{a_pos:function(e,t){var i=t.a_pos;return i}},uniforms:{u_matrix:function(e,t){var i=t.u_matrix;return i},u_image:function(e,t){var i=t.u_image;return i},u_tile:function(e,t){var i=t.u_tile;return i},u_opacity:function(e,t){var i=t.u_opacity;return i},u_extrude_scale:function(e,t){var i=t.u_extrude_scale;return i}},depth:{enable:!0,mask:!0,func:"less",range:[0,1]},blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},color:[0,0,0,0]},elements:function(e,t){var i=t.elements;return i}})},e.prototype.move=function(){this.updateTiles("terrainSourceCache"),this.updateTiles("sourceCache")},e.prototype.onData=function(e){"content"===e.sourceDataType&&this.updateTiles("sourceCache")},e.prototype.onTerrainData=function(e){"content"===e.sourceDataType&&this.updateTiles("terrainSourceCache")},e.prototype.updateTiles=function(e){this[e].update(this.map.painter.transform)},e.prototype.getPlaneBuffer=function(e,t,i,r,o){if(e._planeBuffer&&e.widthSegments===r&&e.heightSegments===o)return e._planeBuffer;e.widthSegments=r,e.heightSegments=o;for(var n=t/2,a=i/2,s=Math.floor(r),u=Math.floor(o),c=s+1,l=u+1,h=t/s,p=i/u,f=[],m=[],d=[],g=0;g<l;g++)for(var _=g*p,v=0;v<c;v++){var y=v*h;m.push(y/n/2,_/a/2),d.push(v/s,1-g/u)}for(g=0;g<u;g++)for(v=0;v<s;v++){var x=v+c*g,S=v+c*(g+1),T=v+1+c*(g+1),b=v+1+c*g;f.push(x,S,b),f.push(S,T,b)}return e._planeBuffer={vertices:m,indices:f,uvs:d,elements:this.regl.elements({data:f,primitive:"triangles",type:"uint32",count:f.length}),position:{buffer:this.regl.buffer({data:m,type:"float"}),size:2}},e._planeBuffer},e.prototype.render=function(){var e=this,t=this.terrainSourceCache.getVisibleCoordinates().map((function(t){return e.terrainSourceCache.getTile(t)}));this.command&&t.forEach((function(t){if(t.texture){if(t._terrainTexture||(t._terrainTexture=e.regl.texture({data:t.texture.image,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!0})),!t._reglTexture){var i=e.sourceCache.getTile(t.tileID);i&&i.texture&&(t._reglTexture=e.regl.texture({data:i.texture.image,wrapS:"clamp",wrapT:"clamp",min:"linear",mag:"linear",mipmap:!0}))}if(t._reglTexture){var r=e.getPlaneBuffer(t,256,256,void 0!==e.options.widthSegments?e.options.widthSegments:256,void 0!==e.options.heightSegments?e.options.heightSegments:256);e.command({u_matrix:t.tileID.posMatrix,u_image:t._terrainTexture,u_tile:t._reglTexture,elements:r.elements,a_pos:r.position,u_opacity:void 0!==e.options.opacity?e.options.opacity:1,u_extrude_scale:void 0!==e.options.extrudeScale?e.options.extrudeScale:1})}}}))},e.prototype.setOptions=function(e){this.options=r(r({},this.options),e),this.map&&this.map.triggerRepaint()},e.prototype.onRemove=function(){this.regl.destroy(),this.map.off("move",this.move)},e}()}));
//# sourceMappingURL=terrain-layer.min.js.map
